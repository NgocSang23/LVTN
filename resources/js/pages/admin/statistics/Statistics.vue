<template>
    <div class="container mt-4">
        <h3 class="mb-4 text-center text-dark">üìä Th·ªëng k√™ h·ªá th·ªëng</h3>

        <div v-if="isLoading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">ƒêang t·∫£i...</span>
            </div>
            <p class="mt-2 text-muted">ƒêang t·∫£i d·ªØ li·ªáu th·ªëng k√™...</p>
        </div>

        <div
            v-else-if="error"
            class="alert alert-danger text-center"
            role="alert"
        >
            <i class="fas fa-exclamation-circle me-2"></i> {{ error }}
        </div>

        <div v-else class="row g-3">
            <div
                class="col-sm-6 col-md-4"
                v-for="stat in stats"
                :key="stat.label"
            >
                <div class="card border shadow-sm h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="me-3 text-muted">
                            <i :class="[stat.icon, 'fa-lg']"></i>
                        </div>
                        <div>
                            <p class="mb-1 text-muted small">
                                {{ stat.label }}
                            </p>
                            <h5 class="mb-0 fw-bold">
                                {{ stat.value.toLocaleString() }}
                            </h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚úÖ ƒê√£ th√™m: Bi·ªÉu ƒë·ªì t·∫ßn su·∫•t -->
        <h5 class="mt-5 text-center text-dark">
            üìà T·∫ßn su·∫•t √¥n t·∫≠p (7 ng√†y g·∫ßn nh·∫•t)
        </h5>
        <div class="card p-3 shadow-sm">
            <canvas id="reviewChart"></canvas>
        </div>
    </div>
</template>

<script>
import axios from "axios"; // Import th∆∞ vi·ªán Axios ƒë·ªÉ th·ª±c hi·ªán c√°c y√™u c·∫ßu HTTP (g·ªçi API)
import Chart from "chart.js/auto"; // ‚úÖ ƒê√£ th√™m: Import Chart.js

export default {
    name: "Statistics", // ƒê·∫∑t t√™n cho component Vue n√†y l√† "Statistics"

    data() {
        // H√†m `data` tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng ch·ª©a c√°c d·ªØ li·ªáu reactive c·ªßa component.
        // B·∫•t k·ª≥ s·ª± thay ƒë·ªïi n√†o ƒë·ªëi v·ªõi c√°c thu·ªôc t√≠nh trong ƒë·ªëi t∆∞·ª£ng n√†y s·∫Ω k√≠ch ho·∫°t vi·ªác c·∫≠p nh·∫≠t giao di·ªán.
        return {
            stats: [], // M·ªôt m·∫£ng r·ªóng ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu th·ªëng k√™ nh·∫≠n ƒë∆∞·ª£c t·ª´ API. M·ªói ph·∫ßn t·ª≠ s·∫Ω l√† m·ªôt ƒë·ªëi t∆∞·ª£ng { label, value, icon }.
            isLoading: true, // M·ªôt bi·∫øn boolean d√πng l√†m c·ªù ƒë·ªÉ theo d√µi tr·∫°ng th√°i t·∫£i d·ªØ li·ªáu. Ban ƒë·∫ßu l√† `true` ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i loading khi component ƒë∆∞·ª£c t·∫°o.
            error: null, // M·ªôt bi·∫øn ƒë·ªÉ l∆∞u tr·ªØ th√¥ng b√°o l·ªói n·∫øu c√≥ v·∫•n ƒë·ªÅ x·∫£y ra trong qu√° tr√¨nh g·ªçi API. Ban ƒë·∫ßu l√† `null`.
            reviewFrequency: [], // ‚úÖ ƒê√£ th√™m: D·ªØ li·ªáu t·∫ßn su·∫•t review
            chartInstance: null, // ‚úÖ ƒê√£ th√™m: Chart instance
        };
    },

    methods: {
        // Kh·ªëi `methods` ch·ª©a c√°c h√†m (ph∆∞∆°ng th·ª©c) m√† component c√≥ th·ªÉ th·ª±c hi·ªán.
        async fetchStatistics() {
            // ƒê√¢y l√† m·ªôt ph∆∞∆°ng th·ª©c b·∫•t ƒë·ªìng b·ªô (async) ƒë·ªÉ t·∫£i d·ªØ li·ªáu th·ªëng k√™ t·ª´ API.
            // S·ª≠ d·ª•ng `async/await` gi√∫p code d·ªÖ ƒë·ªçc v√† qu·∫£n l√Ω c√°c thao t√°c b·∫•t ƒë·ªìng b·ªô h∆°n.

            // Reset tr·∫°ng th√°i l·ªói v√† loading khi b·∫Øt ƒë·∫ßu fetch d·ªØ li·ªáu m·ªõi.
            this.isLoading = true; // B·∫Øt ƒë·∫ßu qu√° tr√¨nh t·∫£i, ƒë·∫∑t `isLoading` th√†nh `true` ƒë·ªÉ hi·ªÉn th·ªã spinner ho·∫∑c th√¥ng b√°o loading.
            this.error = null; // ƒê·∫∑t l·∫°i bi·∫øn `error` v·ªÅ `null` ƒë·ªÉ x√≥a b·∫•t k·ª≥ th√¥ng b√°o l·ªói n√†o t·ª´ l·∫ßn tr∆∞·ªõc.

            try {
                // Kh·ªëi `try` ch·ª©a code c√≥ kh·∫£ nƒÉng g√¢y ra l·ªói.
                const token = localStorage.getItem("admin_token"); // L·∫•y token x√°c th·ª±c (ch·∫≥ng h·∫°n nh∆∞ JWT) t·ª´ Local Storage c·ªßa tr√¨nh duy·ªát. Token n√†y th∆∞·ªùng ƒë∆∞·ª£c y√™u c·∫ßu ƒë·ªÉ truy c·∫≠p c√°c API ƒë∆∞·ª£c b·∫£o v·ªá.

                if (!token) {
                    // N·∫øu kh√¥ng t√¨m th·∫•y token trong Local Storage, n√©m m·ªôt l·ªói.
                    throw new Error(
                        "Kh√¥ng c√≥ token x√°c th·ª±c. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i."
                    );
                }

                // G·ª≠i y√™u c·∫ßu GET ƒë·∫øn endpoint API "/api/admin/statistics/overview".
                // Y√™u c·∫ßu n√†y s·∫Ω l·∫•y d·ªØ li·ªáu t·ªïng quan v·ªÅ th·ªëng k√™ h·ªá th·ªëng t·ª´ backend.
                const res = await axios.get("/api/admin/statistics/overview", {
                    headers: {
                        // Thi·∫øt l·∫≠p c√°c header cho y√™u c·∫ßu HTTP.
                        Authorization: `Bearer ${token}`, // Th√™m token v√†o header `Authorization` v·ªõi ti·ªÅn t·ªë "Bearer" ƒë·ªÉ x√°c th·ª±c y√™u c·∫ßu.
                    },
                });

                const data = res.data; // Tr√≠ch xu·∫•t d·ªØ li·ªáu th·ª±c t·∫ø t·ª´ ph·∫£n h·ªìi c·ªßa API (response body).

                // C·∫≠p nh·∫≠t m·∫£ng `stats` v·ªõi d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c.
                // M·ªói ƒë·ªëi t∆∞·ª£ng trong m·∫£ng `stats` bi·ªÉu di·ªÖn m·ªôt ch·ªâ s·ªë th·ªëng k√™ c·ª• th·ªÉ.
                this.stats = [
                    {
                        label: "T·ªïng ng∆∞·ªùi d√πng", // Nh√£n hi·ªÉn th·ªã cho ch·ªâ s·ªë n√†y.
                        value: data.users || 0, // Gi√° tr·ªã c·ªßa ch·ªâ s·ªë. S·ª≠ d·ª•ng `|| 0` ƒë·ªÉ ƒë·∫£m b·∫£o gi√° tr·ªã l√† 0 n·∫øu `data.users` l√† null/undefined.
                        icon: "fas fa-users", // Class c·ªßa icon Font Awesome t∆∞∆°ng ·ª©ng.
                    },
                    {
                        label: "S·ªë l∆∞·ª£t √¥n t·∫≠p",
                        value: data.totalReviews || 0,
                        icon: "fas fa-book-reader",
                    },
                    {
                        label: "T·ªïng flashcard",
                        value: data.cards || 0,
                        icon: "fas fa-clone",
                    },
                    {
                        label: "B·ªô flashcard chia s·∫ª",
                        value: data.flashcard_sets || 0,
                        icon: "fas fa-layer-group",
                    },
                    {
                        label: "Flashcard trong b·ªô",
                        value: data.cards_in_sets || 0,
                        icon: "fas fa-box",
                    },
                    {
                        label: "Flashcard ch∆∞a trong b·ªô",
                        value: data.cards_not_in_sets || 0,
                        icon: "fas fa-box-open",
                    },
                ];

                // ‚úÖ ƒê√£ th√™m: G·ªçi API l·∫•y d·ªØ li·ªáu t·∫ßn su·∫•t review
                const freqRes = await axios.get(
                    "/api/admin/statistics/review-frequency",
                    {
                        headers: { Authorization: `Bearer ${token}` },
                    }
                );
                this.reviewFrequency = freqRes.data || [];
                this.renderReviewChart();
            } catch (err) {
                // Kh·ªëi `catch` s·∫Ω ƒë∆∞·ª£c th·ª±c thi n·∫øu c√≥ b·∫•t k·ª≥ l·ªói n√†o x·∫£y ra trong kh·ªëi `try`.
                console.error("L·ªói khi l·∫•y th·ªëng k√™:", err); // Ghi log l·ªói ra console ƒë·ªÉ debug.

                // ƒê·∫∑t th√¥ng b√°o l·ªói m·∫∑c ƒë·ªãnh cho ng∆∞·ªùi d√πng.
                this.error = "Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.";

                // Ki·ªÉm tra c·ª• th·ªÉ l·ªói 401 (Unauthorized) ƒë·ªÉ ƒë∆∞a ra th√¥ng b√°o ph√π h·ª£p h∆°n.
                if (err.response?.status === 401) {
                    // `err.response` ch·ª©a th√¥ng tin ph·∫£n h·ªìi t·ª´ server n·∫øu l·ªói l√† do HTTP request.
                    // `?.status` l√† c√∫ ph√°p optional chaining, ƒë·∫£m b·∫£o kh√¥ng l·ªói n·∫øu `response` kh√¥ng t·ªìn t·∫°i.
                    this.error =
                        "Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.";
                    // Trong ·ª©ng d·ª•ng th·ª±c t·∫ø, b·∫°n c√≥ th·ªÉ chuy·ªÉn h∆∞·ªõng ng∆∞·ªùi d√πng ƒë·∫øn trang ƒëƒÉng nh·∫≠p ·ªü ƒë√¢y.
                }
            } finally {
                // Kh·ªëi `finally` lu√¥n ƒë∆∞·ª£c th·ª±c thi sau `try` v√† `catch`, b·∫•t k·ªÉ c√≥ l·ªói hay kh√¥ng.
                this.isLoading = false; // ƒê·∫∑t `isLoading` th√†nh `false` ƒë·ªÉ ·∫©n spinner loading sau khi thao t√°c fetch ho√†n t·∫•t.
            }
        },

        // ‚úÖ ƒê√£ th√™m: H√†m v·∫Ω bi·ªÉu ƒë·ªì b·∫±ng Chart.js
        renderReviewChart() {
            // L·∫•y ph·∫ßn t·ª≠ canvas c√≥ id l√† "reviewChart" t·ª´ DOM ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì l√™n ƒë√≥
            const ctx = document.getElementById("reviewChart");

            // N·∫øu ƒë√£ c√≥ bi·ªÉu ƒë·ªì (Chart instance) tr∆∞·ªõc ƒë√≥ th√¨ hu·ª∑ n√≥ ƒëi ƒë·ªÉ tr√°nh b·ªã v·∫Ω ch·ªìng bi·ªÉu ƒë·ªì c≈©
            if (this.chartInstance) {
                this.chartInstance.destroy(); // Hu·ª∑ bi·ªÉu ƒë·ªì hi·ªán t·∫°i
            }

            // T·∫°o m·∫£ng nh√£n tr·ª•c X t·ª´ d·ªØ li·ªáu reviewFrequency, m·ªói ph·∫ßn t·ª≠ l√† m·ªôt ng√†y (yyyy-mm-dd)
            const labels = this.reviewFrequency.map((d) => d.date);

            // T·∫°o m·∫£ng d·ªØ li·ªáu tr·ª•c Y l√† s·ªë l∆∞·ª£t √¥n t·∫≠p ·ª©ng v·ªõi t·ª´ng ng√†y
            const data = this.reviewFrequency.map((d) => d.count);

            // T·∫°o bi·ªÉu ƒë·ªì m·ªõi v√† g√°n v√†o `chartInstance` ƒë·ªÉ c√≥ th·ªÉ qu·∫£n l√Ω ho·∫∑c hu·ª∑ l·∫ßn sau
            this.chartInstance = new Chart(ctx, {
                type: "line", // Ki·ªÉu bi·ªÉu ƒë·ªì l√† ƒë∆∞·ªùng (line chart)
                data: {
                    labels, // Tr·ª•c X l√† danh s√°ch ng√†y
                    datasets: [
                        {
                            label: "L∆∞·ª£t √¥n t·∫≠p", // T√™n ƒë∆∞·ªùng bi·ªÉu ƒë·ªì (hi·ªán trong ch√∫ th√≠ch)
                            data, // D·ªØ li·ªáu t∆∞∆°ng ·ª©ng theo ng√†y
                            backgroundColor: "rgba(54, 162, 235, 0.2)", // M√†u n·ªÅn d∆∞·ªõi ƒë∆∞·ªùng bi·ªÉu ƒë·ªì (fill)
                            borderColor: "rgba(54, 162, 235, 1)", // M√†u ƒë∆∞·ªùng bi·ªÉu ƒë·ªì
                            borderWidth: 2, // ƒê·ªô d√†y ƒë∆∞·ªùng k·∫ª
                            fill: true, // C√≥ t√¥ n·ªÅn ph√≠a d∆∞·ªõi ƒë∆∞·ªùng kh√¥ng
                            tension: 0.4, // ƒê·ªô cong c·ªßa ƒë∆∞·ªùng (0: g·∫•p kh√∫c, g·∫ßn 1: cong m·ªÅm m·∫°i)
                        },
                    ],
                },
                options: {
                    responsive: true, // Bi·ªÉu ƒë·ªì ph·∫£n h·ªìi t·ªët khi thay ƒë·ªïi k√≠ch th∆∞·ªõc m√†n h√¨nh
                    maintainAspectRatio: false, // Kh√¥ng gi·ªØ nguy√™n t·ªâ l·ªá khung (cho ph√©p ch·ªânh chi·ªÅu cao)
                    scales: {
                        y: {
                            beginAtZero: true, // B·∫Øt ƒë·∫ßu tr·ª•c Y t·ª´ 0
                            ticks: { stepSize: 1 }, // B∆∞·ªõc nh·∫£y c·ªßa tr·ª•c Y l√† 1 ƒë∆°n v·ªã (l∆∞·ª£t √¥n t·∫≠p)
                        },
                    },
                },
            });
        },
    },

    mounted() {
        // `mounted` l√† m·ªôt lifecycle hook c·ªßa Vue, ƒë∆∞·ª£c g·ªçi m·ªôt l·∫ßn sau khi component ƒë∆∞·ª£c g·∫Øn v√†o DOM (t·ª©c l√† ƒë√£ hi·ªÉn th·ªã tr√™n tr√¨nh duy·ªát).
        // ƒê√¢y l√† n∆°i l√Ω t∆∞·ªüng ƒë·ªÉ th·ª±c hi·ªán c√°c thao t√°c t·∫£i d·ªØ li·ªáu ban ƒë·∫ßu.
        this.fetchStatistics(); // G·ªçi ph∆∞∆°ng th·ª©c `fetchStatistics` ƒë·ªÉ b·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu th·ªëng k√™ ngay khi component ƒë∆∞·ª£c t·∫£i.
    },
};
</script>

<style scoped>
.card {
    transition: none;
    border-radius: 10px;
}
.card .fa-lg {
    font-size: 1.5rem;
}
canvas {
    width: 100% !important;
    height: 300px !important;
}
/* ‚úÖ ƒê√£ th√™m: Chi·ªÅu cao cho canvas */
</style>
